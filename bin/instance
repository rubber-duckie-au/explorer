#!/usr/bin/env node
var debug = require('debug')('explorer');
var settings = require('../lib/settings');
var db = require('../lib/database');
var app = require('../app');

app.set('port', process.env.PORT || settings.port);

var dbString = 'mongodb://' + settings.dbsettings.user;
dbString = dbString + ':' + settings.dbsettings.password;
dbString = dbString + '@' + settings.dbsettings.address;
dbString = dbString + ':' + settings.dbsettings.port;
dbString = dbString + '/' + settings.dbsettings.database;

db.connect(dbString, function() {
  db.check_stats(settings.coin, function(exists) {
    if (exists == false) {
      console.log('no stats entry found, creating now..');
      db.create_stats(settings.coin, function(){
        //console.log('stats entry created successfully.');
      });
    } else {
      db.get_stats(settings.coin, function (stats) {
        app.locals.stats = stats;
      });
    }
  });
  // check markets
  var markets = settings.markets.enabled;
  for (var i = 0; i < markets.length; i++) {
    db.check_market(markets[i], function(market, exists) {
      if(exists == false) {
        console.log('no %s entry found, creating now..', market);
          db.create_market(settings.markets.coin, settings.markets.exchange, market, function(){
        });
      }
    });  
  } 
  
  db.check_richlist(settings.coin, function(exists){
    if (exists == false) {
      console.log('no richlist entry found, creating now..');
      db.create_richlist(settings.coin, function() {

      });
    }
  });  
  if ( settings.heavy == true ) {
    db.check_heavy(settings.coin, function(exists){
      if (exists == false) {
        console.log('no heavy entry found, creating now..');
        db.create_heavy(settings.coin, function() {

        });
      }
    }); 
  }
  if ( settings.https_site == true ) {
console.log('in HTTPS loop');
    var fs = require('fs');
    var certRoot = '/etc/letsencrypt/live/' + settings.site_url + '/';

    var options = {
      ca: fs.readFileSync(certRoot + 'chain.pem'),
      cert: fs.readFileSync(certRoot + 'cert.pem'),
      key: fs.readFileSync(certRoot + 'privkey.pem'),
    };

    var http = require('http')
    var https = require('https')
 
    http.createServer(function(req, res) {
	if (req.url.indexOf('/.well-known/acme-challenge/') >= 0) {
	    console.log(req.url)
	    //res.send();
	    res.writeHead(200); 
            var contents = fs.readFileSync('./public' + req.url)
	    res.end(contents);
 
	} else {
	    res.writeHead(301, {"Location": "https://" + req.headers['host'] + req.url});
            console.log('redirected')
            res.end();

}
    }).listen(80);
 
    https.createServer(options, app).listen(443); 
  
} else {

  var server = app.listen(app.get('port'), '::', function() {
    debug('Express server listening on port ' + server.address().port);
  });
  }
});
